<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel - Intenção de Almoço</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f8; }
      .container { max-width: 1080px; margin: 24px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.08); }
      .logo { width: 100%; max-width: 420px; display: block; margin: 0 auto 16px auto; }
      h1 { margin-top: 0; }
      .totais { display: flex; gap: 14px; flex-wrap: wrap; margin: 14px 0 20px; }
      .card { background: #eef3ff; border: 1px solid #d7e2ff; border-radius: 8px; padding: 10px 14px; min-width: 160px; }
      table { width: 100%; border-collapse: collapse; margin-top: 14px; }
      th, td { border: 1px solid #dce1e7; padding: 8px; text-align: left; }
      th { background: #f0f3f7; }
      .center { text-align: center; }
      .quadro th, .quadro td { border: 1px solid #5f5f5f; }
      .quadro thead th { background: #e8e8e8; }
      .total-row th, .total-row td { background: #fff200; font-weight: 700; }
      .filtro { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      input, button, a.btn { padding: 8px 10px; border-radius: 8px; border: 1px solid #cfd6dd; text-decoration: none; color: #111; }
      button, a.btn.primary { background: #0b5ed7; border-color: #0b5ed7; color: #fff; cursor: pointer; }
      .split { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .alert { padding: 10px 12px; border-radius: 8px; margin-top: 12px; }
      .ok { background: #d1f7de; color: #0b5a2a; }
      .err { background: #ffd9d9; color: #8f1a1a; }
      @media (max-width: 900px) { .split { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <main class="container">
      <img class="logo" src="/static/logo_ifc_horizontal_SaoBentodosul.png" onerror="this.onerror=null;this.src='/static/logo-ifc.svg';" alt="Instituto Federal Catarinense" />
      <h1>Painel de Intenção de Almoço</h1>

      {% if importado %}
      <div class="alert ok">Lista de alunos importada com sucesso.</div>
      {% endif %}

      {% if import_error %}
      <div class="alert err">{{ import_error }}</div>
      {% endif %}

      <form class="filtro" method="get" action="/admin">
        <input type="hidden" name="token" value="{{ token }}" />
        <label for="data">Data:</label>
        <input type="date" id="data" name="data" value="{{ data_filtro }}" />
        <label for="periodo">Relatório:</label>
        <select id="periodo" name="periodo">
          <option value="semana" {% if periodo == 'semana' %}selected{% endif %}>Semana</option>
          <option value="mes" {% if periodo == 'mes' %}selected{% endif %}>Mês</option>
          <option value="ano" {% if periodo == 'ano' %}selected{% endif %}>Ano</option>
        </select>
        <button type="submit">Atualizar</button>
        <a class="btn primary" href="/export.csv?data={{ data_filtro }}&periodo={{ periodo }}&token={{ token }}">Exportar CSV</a>
        <a class="btn primary" href="/export_quadro.csv?data={{ data_filtro }}&token={{ token }}">Exportar quadro semanal (CSV)</a>
        <a class="btn primary" href="/admin/planilha?token={{ token }}&turma=TIN I&semana={{ data_filtro }}">Planilha semanal (ODS)</a>
      </form>

      <form class="filtro" method="post" action="/admin/importar_alunos" enctype="multipart/form-data">
        <input type="hidden" name="token" value="{{ token }}" />
        <input type="hidden" name="data" value="{{ data_filtro }}" />
        <label for="arquivo_csv">Importar alunos (CSV/XLSX: nome,matricula,turma):</label>
        <input type="file" id="arquivo_csv" name="arquivo_csv" accept=".csv,.xlsx" required />
        <button type="submit">Importar arquivo</button>
      </form>

      <section class="totais">
        <div class="card"><strong>SIM:</strong> {{ total_sim }}</div>
        <div class="card"><strong>NÃO:</strong> {{ total_nao }}</div>
        <div class="card"><strong>TOTAL (SIM):</strong> {{ total_geral }}</div>
      </section>

      <h2>Relatório por período</h2>
      <div>Período: {{ periodo_label }} | {{ periodo_inicio }} até {{ periodo_fim }}</div>
      <section class="totais">
        <div class="card"><strong>Total da semana:</strong> {{ total_semana_periodo }}</div>
        <div class="card"><strong>Total do mês:</strong> {{ total_mes_periodo }}</div>
        <div class="card"><strong>Total do ano:</strong> {{ total_ano_periodo }}</div>
        <div class="card"><strong>SIM no período:</strong> {{ total_periodo_sim }}</div>
        <div class="card"><strong>NÃO no período:</strong> {{ total_periodo_nao }}</div>
      </section>

      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th class="center">SIM</th>
            <th class="center">NÃO</th>
            <th class="center">Total</th>
          </tr>
        </thead>
        <tbody>
          {% for item in relatorio_periodo %}
          <tr>
            <td>{{ item.data }}</td>
            <td class="center">{{ item.sim }}</td>
            <td class="center">{{ item.nao }}</td>
            <td class="center"><strong>{{ item.total }}</strong></td>
          </tr>
          {% endfor %}
          {% if not relatorio_periodo %}
          <tr>
            <td colspan="4" class="center">Sem registros no período selecionado.</td>
          </tr>
          {% endif %}
        </tbody>
      </table>

      <h2>Quadro semanal por turma (SIM)</h2>
      <div>Semana considerada: {{ semana_inicio }} até {{ semana_fim }}</div>
      <table class="quadro">
            <thead>
              <tr>
                <th class="center" style="width:50px">#</th>
                <th>Turma</th>
                <th class="center">Seg</th>
                <th class="center">Ter</th>
                <th class="center">Qua</th>
                <th class="center">Qui</th>
                <th class="center">Sex</th>
                <th class="center" style="width:90px">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for row in quadro_rows %}
              <tr>
                <td class="center">{{ row.ordem }}</td>
                <td>{{ row.turma_nome }}</td>
                <td class="center">{{ row.seg }}</td>
                <td class="center">{{ row.ter }}</td>
                <td class="center">{{ row.qua }}</td>
                <td class="center">{{ row.qui }}</td>
                <td class="center">{{ row.sex }}</td>
                <td class="center"><strong>{{ row.total }}</strong></td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr class="total-row">
                <th class="center" colspan="2">Total</th>
                <th class="center">{{ semana_sim.seg }}</th>
                <th class="center">{{ semana_sim.ter }}</th>
                <th class="center">{{ semana_sim.qua }}</th>
                <th class="center">{{ semana_sim.qui }}</th>
                <th class="center">{{ semana_sim.sex }}</th>
                <th class="center">{{ total_semana_geral }}</th>
              </tr>
            </tfoot>
          </table>

      <div class="split">
        <section>
          <h2>Respostas da semana (checks positivos)</h2>
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Turma</th>
                <th>Intenção (dias com ✅)</th>
              </tr>
            </thead>
            <tbody>
              {% for row in respostas %}
              <tr>
                <td>{{ row.nome }}</td>
                <td>{{ row.turma }}</td>
                <td>{{ row.intencao }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </section>
      </div>
    </main>
  </body>
</html>
